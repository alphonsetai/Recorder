/*
录音
https://github.com/xiangyuecn/Recorder
src: extensions/frequency.histogram.view.js
*/
!function(){"use strict";var t=function(t){return new e(t)},e=function(t){var e=this,r={scale:2,fps:20,lineCount:30,lineWidth:6,minHeight:0,position:-1,stripeEnable:!0,stripeHeight:3,stripeMargin:6,fallDuration:1e3,stripeFallDuration:3500,linear:[0,"rgba(0,187,17,1)",.5,"rgba(255,215,0,1)",1,"rgba(255,102,0,1)"],stripeLinear:null,shadowBlur:0,shadowColor:"#bbb",stripeShadowBlur:-1,stripeShadowColor:"",onDraw:function(t,e){}};for(var i in t)r[i]=t[i];e.set=t=r;var a=t.elem;a&&("string"==typeof a?a=document.querySelector(a):a.length&&(a=a[0])),a&&(t.width=a.offsetWidth,t.height=a.offsetHeight);var o=t.scale,n=t.width*o,l=t.height*o,h=e.elem=document.createElement("div"),s=["","transform-origin:0 0;","transform:scale("+1/o+");"];h.innerHTML='<div style="width:'+t.width+"px;height:"+t.height+'px;overflow:hidden"><div style="width:'+n+"px;height:"+l+"px;"+s.join("-webkit-")+s.join("-ms-")+s.join("-moz-")+s.join("")+'"><canvas/></div></div>';var f=e.canvas=h.querySelector("canvas");e.ctx=f.getContext("2d");if(f.width=n,f.height=l,a&&(a.innerHTML="",a.appendChild(h)),!Recorder.LibFFT)throw new Error("需要lib.fft.js支持");e.fft=Recorder.LibFFT(1024),e.lastH=[],e.stripesH=[]};e.prototype=t.prototype={genLinear:function(t,e,r,i){for(var a=t.createLinearGradient(0,r,0,i),o=0;o<e.length;)a.addColorStop(e[o++],e[o++]);return a},input:function(t,e,r){var i=this;i.sampleRate=r,i.pcmData=t,i.pcmPos=0,i.inputTime=Date.now(),i.schedule()},schedule:function(){var t=this,e=t.set,r=Math.floor(1e3/e.fps);t.timer||(t.timer=setInterval(function(){t.schedule()},r));var i=Date.now(),a=t.drawTime||0;if(i-t.inputTime>1.3*e.stripeFallDuration)return clearInterval(t.timer),void(t.timer=0);if(!(i-a<r)){t.drawTime=i;for(var o=t.fft.bufferSize,n=t.pcmData,l=t.pcmPos,h=new Int16Array(o),s=0;s<o&&l<n.length;s++,l++)h[s]=n[l];t.pcmPos=l;var f=t.fft.transform(h);t.draw(f,t.sampleRate)}},draw:function(t,e){var r=this,i=r.set,a=r.ctx,o=i.scale,n=i.width*o,l=i.height*o,h=i.lineCount,s=r.fft.bufferSize,f=i.position,d=Math.abs(i.position),p=1==f?0:l,c=l;d<1&&(p=c/=2,c=Math.floor(c*(1+d)),p=Math.floor(0<f?p*(1-d):p*(1+d)));for(var u=r.lastH,g=r.stripesH,v=Math.ceil(c/(i.fallDuration/(1e3/i.fps))),w=Math.ceil(c/(i.stripeFallDuration/(1e3/i.fps))),m=i.stripeMargin*o,M=1<<(Math.round(Math.log(s)/Math.log(2)+3)<<1),b=Math.log(M)/Math.log(10),L=20*Math.log(32767)/Math.log(10),y=s/2,S=Math.min(y,Math.floor(5e3*y/(e/2))),C=S==y,H=C?h:Math.round(.8*h),D=S/H,x=C?0:(y-S)/(h-H),R=0,F=0;F<h;F++){var T=Math.ceil(R);R+=F<H?D:x;for(var B=Math.min(Math.ceil(R),y),j=0,E=T;E<B;E++)j=Math.max(j,Math.abs(t[E]));var q=M<j?Math.floor(17*(Math.log(j)/Math.log(10)-b)):0,z=c*Math.min(q/L,1);u[F]=(u[F]||0)-v,z<u[F]&&(z=u[F]),z<0&&(z=0),u[F]=z;var I=g[F]||0;if(z&&I<z+m)g[F]=z+m;else{var P=I-w;P<0&&(P=0),g[F]=P}}a.clearRect(0,0,n,l);var W=r.genLinear(a,i.linear,p,p-c),k=i.stripeLinear&&r.genLinear(a,i.stripeLinear,p,p-c)||W,A=r.genLinear(a,i.linear,p,p+c),G=i.stripeLinear&&r.genLinear(a,i.stripeLinear,p,p+c)||A;a.shadowBlur=i.shadowBlur*o,a.shadowColor=i.shadowColor;var V=i.lineWidth*o;n<V*h+(h+1)*o&&(V=Math.max(1*o,Math.floor((n-(h+1)*o)/h)));for(var J=(n-h*V)/(h+1),K=i.minHeight*o,N=(F=0,0);F<h;F++)N+=J,Q=Math.floor(N),z=Math.max(u[F],K),0!=p&&(U=p-z,a.fillStyle=W,a.fillRect(Q,U,V,z)),p!=l&&(a.fillStyle=A,a.fillRect(Q,p,V,z)),N+=V;if(i.stripeEnable){var O=i.stripeShadowBlur;a.shadowBlur=(-1==O?i.shadowBlur:O)*o,a.shadowColor=i.stripeShadowColor||i.shadowColor;var Q,U,X=i.stripeHeight*o;for(F=0,N=0;F<h;F++)N+=J,Q=Math.floor(N),z=g[F],0!=p&&((U=p-z-X)<0&&(U=0),a.fillStyle=k,a.fillRect(Q,U,V,X)),p!=l&&(l<(U=p+z)+X&&(U=l-X),a.fillStyle=G,a.fillRect(Q,U,V,X)),N+=V}i.onDraw(t)}},Recorder.FrequencyHistogramView=t}();