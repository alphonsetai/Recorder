/*
录音
https://github.com/xiangyuecn/Recorder
src: app-support/app.js,app-support/app-ios-weixin-support.js,app-support/app-native-support.js
*/
!function(e){"use strict";var t=/MicroMessenger/i.test(navigator.userAgent),n=e.RecordAppBaseFolder||"/Recorder/dist/",o=e.OnRecordAppInstalled,a=[{Key:"Native",Support:function(n){f.AlwaysAppUseJS?n(!1):r.Config.IsApp(n)},CanProcess:function(){return!0},Config:{IsApp:function(n){n(!1)},JsBridgeRequestPermission:function(n,e){e("JsBridgeRequestPermission未实现")},JsBridgeStart:function(n,e,t){t("JsBridgeStart未实现")},JsBridgeStop:function(n,e){e("JsBridgeStop未实现")},paths:[{url:n+"app-support/app-native-support.js",check:function(){return!r.IsInit}}]},ExtendDefault:!0},{Key:"IOS-Weixin",Support:function(n){f.AlwaysUseWeixinJS||!Recorder.Support()?n(t):n(!1)},CanProcess:function(){return!1},Config:{WxReady:function(n){n(null,"未实现IOS-Weixin.Config.WxReady")},DownWxMedia:function(n,e,t){t("下载素材接口DownWxMedia未实现")},paths:[{url:n+"app-support/app-ios-weixin-support.js",check:function(){return!i.IsInit}},{url:n+"engine/beta-amr.js",check:function(){return!Recorder.prototype.amr}}]},ExtendDefault:!0},{Key:"Default",Support:function(n){n(!0)},CanProcess:function(){return!0},Config:{paths:[{url:n+"recorder-core.js",check:function(){return!e.Recorder}},{url:n+"engine/mp3.js",check:function(){return!Recorder.prototype.mp3}}]}}],r=a[0],i=a[1],l=a[2];l.RequestPermission=function(n,e){var t=f.__Rec;t&&(t.close(),f.__Rec=null);var o=Recorder();o.open(function(){n()},e)},l.Start=function(n,e,t){var o=f.__Rec;null!=o&&o.close(),f.__Rec=o=Recorder(n),o.appSet=n,o.open(function(){o.start(),e()},function(n){t(n)})},l.Stop=function(t,e){var o=f.__Rec;if(!o)return Recorder.IsOpen()&&((o=Recorder()).open(),o.close()),void e("未开始录音");var r=function(){for(var n in o.close(),o.set)o.appSet[n]=o.set[n]},n=function(n){r(),e(n),f.__Rec=null};t?o.stop(function(n,e){r(),t(n,e),f.__Rec=null},n):n("仅清理资源")};var f={LM:"2019-10-26 11:23:48",Current:0,IsWx:t,BaseFolder:n,AlwaysUseWeixinJS:!1,AlwaysAppUseJS:!1,Platforms:{Native:r,Weixin:i,Default:l},Js:function(r,i,s,n){var c=(n=n||e).document,u=function(n){if(n>=r.length)i();else{var e=r[n],t=e.url;if(!1!==e.check()){var o=c.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("src",t),o.onload=function(){u(n+1)},o.onerror=function(n){s("请求失败:"+(n.message||"-")+"，"+t)},c.body.appendChild(o)}else u(n+1)}};u(0)},Install:function(t,o){var r=f.__reqs||(f.__reqs=[]);r.push({s:t,f:o}),t=function(){i("s",arguments)},o=function(n,e){i("f",arguments)};var i=function(n,e){for(var t=0;t<r.length;t++)r[t][n].apply(null,e);r.length=0};if(!(1<r.length)){var s=0,c=function(e,n){if(e.IsInit)n();else{var t=e.Config;f.Js(t.paths,function(){e.IsInit=!0,n()},function(n){n="初始化js库失败："+n,console.log(n,e),o(n)})}},u=function(e){if(e)f.Current=e,t();else{var n=function(){e.Support(function(n){n?c(e,function(){u(e)}):(s++,u())})};(e=a[s]).ExtendDefault?c(l,n):n()}};u(f.Current)}},GetStartUsedRecOrNull:function(){return f.__Rec||null},RequestPermission:function(e,t){f.Install(function(){var n=f.Current;console.log("开始请求"+n.Key+"录音权限"),n.RequestPermission(function(){console.log("录音权限请求成功"),e&&e()},function(n,e){console.log("录音权限请求失败："+n+",isUserNotAllow:"+e),t&&t(n,e)})},function(n){console.log("Install失败",n),t&&t(n)})},Start:function(n,e,t){var o=f.Current;if(o){n||(n={});var r={type:"mp3",sampleRate:16e3,bitRate:16,onProcess:function(){}};for(var i in r)n[i]||(n[i]=r[i]);o.Start(n,function(){console.log("开始录音",n),e&&e()},function(n){console.log("开始录音失败："+n),t&&t(n)})}else t&&t("需先调用RequestPermission")},Stop:function(t,e){var n=f.Current;n?n.Stop(t?function(n,e){console.log("结束录音"+n.size+"b "+e+"ms",n),t(n,e)}:null,function(n){console.log("结束录音失败："+n),e&&e(n)}):e&&e("需先调用RequestPermission")}};e.RecordApp=f,o&&o()}(window),"function"==typeof define&&define.amd&&define(function(){return RecordApp}),"object"==typeof module&&module.exports&&(module.exports=RecordApp),function(){"use strict";var i=RecordApp.Platforms.Weixin,R=i.Config;i.IsInit=!0;var s,c,u={};i.RequestPermission=function(t,o){R.WxReady(function(n,e){u.wx=null,e?o("微信JsSDK准备失败："+e):(u.wx=n,c?a(function(){i.RequestPermission(t,o)}):n.startRecord({success:function(){setTimeout(function(){g(function(n){!n||/short/i.test(n)?t():o("清理资源出错："+n)})},100)},fail:function(n){o("无法录音："+n.errMsg)},cancel:function(n){o("用户不允许录音："+n.errMsg,!0)}}))})};var g=function(e){s=c=0,u.wx.stopRecord({success:function(){e&&e()},fail:function(n){e&&e("无法结束录音："+n.errMsg)}})},a=function(n){console.warn("录音中，正在kill重试"),g(function(){setTimeout(n,300)})},h=function(n){console.log("["+Date.now()+"]"+n)};i.Start=function(n,e,t){var o=u.wx;if(o)if(c)a(function(){i.Start(n,e,t)});else{if(s)return console.log("等待上次wx.startRecord回调后重试"),void setTimeout(function(){i.Start(n,e,t)},600);c=0,s=1;var r=function(n){s=0,t("无法录音："+n.errMsg),g()};o.startRecord({success:function(){c=1,s=0,u.startTime=Date.now(),u.start=n,h("已开始录音"),e()},fail:r,cancel:r}),u.chunks=[],u.chunkErr="",u.stopJoinEnd=null,o.onVoiceRecordEnd({complete:function(n){var e=Date.now();u.stopJoinEnd?u.stopJoinEnd(n,"chunk"):n.localId&&u.chunks?u.chunks.push({res:n,duration:e-u.startTime,time:e,from:"chunk"}):console.error("已忽略chunk数据",n),h("微信录音超时，正在重启..."),c?o.startRecord({success:function(){u.startTime=Date.now(),console.log("已接续录音,中断"+(Date.now()-e)+"ms")},fail:function(n){var e="无法接续录音："+n.errMsg;console.error(e,n),u.chunkErr=e}}):console.error("已停止录音，拒绝重启")}})}else t("请先调用RequestPermission")},i.Stop=function(f,e){c=0,h("开始停止录音");var p=function(n){e("录音失败："+(n.errMsg||n))},d=u.start;if(d){u.start=null;var v={list:[]};d.DownWxMediaData=v;var a=function(){var r=v.list,n=r[0];if(n.duration){for(var e=atob(n.data),t=e.length,o=new Uint8Array(t);t--;)o[t]=e.charCodeAt(t);var i=new Blob([o.buffer],{type:n.mime});f(i,n.duration)}else{var s=[],c=0,u=0,a=0,l=function(){if(a||(a=Date.now()),u>=r.length)return v.decodeTime=Date.now()-a,void function(){c||(c=Date.now());for(var n=[],e=0;e<s.length;e++)for(var t=s[e],o=0;o<t.length;o++)n.push(t[o]);var r=Recorder(d).mock(n,8e3);r.stop(function(n,e){for(var t in v.encodeTime=Date.now()-c,r.set)d[t]=r.set[t];f(n,e)},p)}();var n=r[u];n.duration=m[u].duration,n.isAmr=!0;for(var e=atob(n.data),t=e.length,o=new Uint8Array(t);t--;)o[t]=e.charCodeAt(t);Recorder.AMR.decode(o,function(n){s.push(n),u++,l()},function(n){p("AMR音频"+(u+1)+"无法解码:"+n)})};Recorder.AMR?l():p("未加载AMR转换引擎")}},l=[],o=function(){if(f){for(var e=[],n=0;n<m.length;n++)e.push(m[n].res.localId);h("结束录音共"+e.length+"段，开始上传下载"),console.log(e,m);var t=0,o=0,r=function(){v.downTime=Date.now()-o,a()},i=function(){if(o||(o=Date.now()),t>=l.length)r();else{var n=l[t];R.DownWxMedia({mediaId:n,transform_mediaIds:l.join(","),transform_type:d.type,transform_bitRate:d.bitRate,transform_sampleRate:d.sampleRate},function(n){v.list.push(n),n.duration?r():/amr/i.test(n.mime)?(t++,i()):p("微信服务器返回了未知音频类型："+n.mime)},function(n){p("下载音频失败："+n)})}},s=0,c=function(){if(s>=e.length)return v.uploadTime=Date.now()-u,void i();var n=e[s];console.log("微信录音片段"+s+" wx.playVoice({localId:'"+n+"'})"),wx.uploadVoice({localId:n,isShowProgressTips:0,fail:p,success:function(n){var e=n.serverId;console.log("serverId:"+e),l.push(e),s++,c()}})},u=Date.now();c()}else p("仅清理资源")},m=u.chunks;if(u.chunkErr)return console.error(u.chunkErr,m),void p("录制失败，已录制"+m.length+"分钟，但后面出错："+u.chunkErr);if(m.length&&Date.now()-m[m.length-1].time<900)return console.error("丢弃结尾未停止太短录音"),g(),void o();u.stopJoinEnd=function(n,e){u.stopJoinEnd=null;var t=Date.now();n.localId?m.push({res:n,duration:t-u.startTime,time:t,from:e}):console.error("已忽略"+e+"数据",n),u.chunks=null,o()},u.wx.stopRecord({fail:p,success:function(n){u.stopJoinEnd&&u.stopJoinEnd(n,"stop")}})}else p("未开始录音")}}(),function(){"use strict";var i=RecordApp,n=i.Platforms.Native,s=n.Config;n.IsInit=!0;var l=window.NativeRecordReceivePCM=window.top.NativeRecordReceivePCM=function(n,e){var t=l.rec;if(t){t._appStart||t.envStart(1,e),t._appStart=1;for(var o,r=atob(n),i=r.length,s=new Int16Array(i/2),c=0,u=0,a=0;a+2<=i;u++,a+=2)o=(r.charCodeAt(a)|r.charCodeAt(a+1)<<8)<<16>>16,s[u]=o,c+=Math.abs(o);t.envIn(s,c)}else console.error("未开始录音，但收到Native PCM数据")};n.RequestPermission=function(n,e){s.JsBridgeRequestPermission(n,e)},n.Start=function(n,e,t){l.param=n;var o=Recorder(n);o.set.disableEnvInFix=!0,l.rec=o,i.__Rec=o,s.JsBridgeStart(n,e,t)},n.Stop=function(o,e){var r=function(n){e(n),l.rec=null,i.__Rec=null};s.JsBridgeStop(function(){var e=l.rec;if(l.rec=null,e){console.log("rec encode start: pcm:"+e.recSize+" src:"+e.srcSampleRate+" set:"+JSON.stringify(l.param));var t=function(){for(var n in e.set)l.param[n]=e.set[n]};if(!o)return t(),void r("仅清理资源");e.stop(function(n,e){console.log("rec encode end"),t(),o(n,e),i.__Rec=null},function(n){t(),r(n)})}else r("未开始录音")},r)}}();